{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "vmName": {
      "type": "string",
      "metadata": {
        "description": "The name of the VM that the extension is being deployed to."
      }
    },
    "registrationURL": {
      "type": "string",
      "metadata": {
        "description": "Azure Automation DSC URL"
      }
    },
    "registrationKey": {
      "type": "securestring",
      "metadata": {
        "description": "Access Key for onboarding VMs into Azure Automation DSC."
      }
    },
    "typeHandlerVersion": {
      "type": "string",
      "defaultValue": "2.77",
      "metadata": {
        "description": "The version of the script handler."
      }
    },
    "nodeConfigurationName": {
      "type": "string",
      "metadata": {
        "description": "Name of the node configuration in the Automation account to assign to the node."
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for all resources."
      }
    }
  },
  "variables": {},
  "resources": [
    {
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(parameters('vmName'), '/Microsoft.Powershell.DSC')]",
      "apiVersion": "2018-10-01",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[concat('Microsoft.Compute/virtualMachines/', parameters('vmName'))]"
      ],
      "properties": {
        "publisher": "Microsoft.Powershell",
        "type": "DSC",
        "typeHandlerVersion": "[parameters('typeHandlerVersion')]",
        "autoUpgradeMinorVersion": true,
        "protectedSettings": {
          "Items": {
            "registrationKeyPrivate": "[parameters('registrationKey')]"
          }
        },
        "settings": {
          "Properties": [
            {
              "Name": "RegistrationKey",
              "Value": {
                "UserName": "PLACEHOLDER_DONOTUSE",
                "Password": "PrivateSettingsRef:registrationKeyPrivate"
              },
              "TypeName": "System.Management.Automation.PSCredential"
            },
            {
              "Name": "RegistrationUrl",
              "Value": "[parameters('registrationURL')]",
              "TypeName": "System.String"
            },
            {
              "Name": "NodeConfigurationName",
              "Value": "[parameters('nodeConfigurationName')]",
              "TypeName": "System.String"
            }
          ]
        }
      }
    }
  ]
}
